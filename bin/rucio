#!/usr/bin/env python
# Copyright European Organization for Nuclear Research (CERN) since 2012
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import argparse
import sys
from multiprocessing import Process
from typing import Optional

from rucio.cli.bin_legacy.rucio import get_parser
from rucio.cli.bin_legacy.rucio import main as main_legacy
from rucio.cli.command import main
from rucio.common.exception import RucioException
from rucio.common.utils import setup_logger


def _get_first_command(args: list[str]) -> Optional[str]:
    return next(
        (
            arg for arg in args
            if arg != 'rucio' and (arg[0] != "-" or arg in ("-h", "--help", "--version"))
        ),
        None
    )


def make_warning() -> str:
    warning = "This method is being deprecated in version 4X.X.X. Use `--legacy` to access it"
    new_command = map_legacy_command()
    if new_command is not None:
        warning += f" or use `rucio {' '.join(new_command)}`."
    else:
        warning += " or view rucio -h for updated commands."

    return warning


def map_legacy_command() -> Optional[list[str]]:
    command = _get_first_command(sys.argv[1:])

    new_command = None
    if command not in ("-h", "--version", None):
        command_map = {
            "list-file-replicas": ["replica", "list", "file"],
            "list-dataset-replicas": ["replica", "list", "dataset"],
            "list-datasets-rse": ["replica", "list", "dataset", "--rse"],
            "add-dataset": ["did", "add", "--type dataset"],
            "add-container": ["did", "add", "--type container"],
            "attach": ["did", "content", "add"],
            "detach": ["did", "content", "remove"],
            "ls": ["did", "list"],
            "list-dids": ["did", "list"],
            "list-parent-dids": ["did", "list", "--parent"],
            "list-scopes": ["scope", "list"],
            "close": ["did", "update", "--close"],
            "reopen": ["did", "update", "--open"],
            "stat": ["did", "show"],
            "erase": ["did", "remove"],
            "list-content": ["did", "content", "list"],
            "list-content-history": ["did", "content", "history"],
            "upload": ["upload"],
            "get": ["download"],
            "download": ["download"],
            "get-metadata": ["did", "metadata", "list"],
            "set-metadata": ["did", "metadata", "add"],
            "delete-metadata": ["did", "metadata", "remove"],
            "list-rse-usage": ["rse", "show"],
            "list-account-usage": ["account", "limit", "list"],
            "list-account-limits": ["account", "limit", "list"],
            "add-rule": ["rule", "add"],
            "delete-rule": ["rule", "remove"],
            "rule-info": ["rule", "show"],
            "list-rules": ["rule", "list"],
            "list-rules-history": ["rule", "history"],
            "update-rule": ["rule", "update"],
            "move-rule": ["rule", "move"],
            "list-rses": ["rse", "list"],
            "list-suspicious-replicas": ["replica", "state", "suspicious"],
            "list-rse-attributes": ["rse", "attribute", "list"],
            "touch": ["did", "update", "--touch"],
            "add-lifetime-exception": ["lifetime-exception", "add"],
        }
        new_command = command_map.get(command)

    return new_command


if __name__ == "__main__":
    commands = ("account", "config", "did", "replica", "rse", "rule", "scope", "subscription", "ping", "whoami", "test-server", "lifetime-exception", "upload", "download", "opendata")

    parser = argparse.ArgumentParser(add_help=False)
    # Check for legacy flag
    parser.add_argument("--legacy", action="store_true")
    # Check for commands in the new command list
    parser.add_argument("-h", "--help", action="store_true")
    parser.add_argument("--version", action="store_true")

    args, _ = parser.parse_known_args()

    logger = setup_logger(module_name=__name__)
    msg = make_warning()

    if args.legacy:
        logger.warning(msg)
        sys.argv.pop(sys.argv.index('--legacy'))
        main_legacy()

    elif (any(arg in commands for arg in sys.argv)) or args.help or args.version:
        main()  # pylint: disable=E1120

    else:
        # These calls are done as subprocesses to manually set the error codes
        # and to avoid parse_args from throwing an exitcode before we can log the error
        subprocess = Process(target=get_parser().parse_args)
        subprocess.start()
        subprocess.join()
        if subprocess.exitcode != 0:
            logger.error("Invalid argument(s) - %s " % sys.argv[1:])
            logger.error(msg)
            sys.argv = ["rucio", "-h"]
            subprocess = Process(target=main)
            subprocess.start()
            subprocess.join()
            sys.exit(1)
        else:
            raise RucioException(msg)
