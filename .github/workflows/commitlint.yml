name: Commitlint

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  commitlint:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.event.head_commit.author.name != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm install

      - name: Validate current commit (push)
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Normal case: lint all commits that are part of this push (BEFORE..AFTER).
          if [[ "$BEFORE" != "0000000000000000000000000000000000000000" ]] && git cat-file -e "${BEFORE}^{commit}" 2>/dev/null; then
            npx commitlint --from "$BEFORE" --to "$AFTER" --verbose
            exit 0
          fi

          # Edge cases (new branch push or force-push): lint commits listed in the push event payload.
          node - <<'NODE' > /tmp/push_commits.txt
          const fs = require('fs');
          const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
          const commits = (event.commits || []).map(c => c.id).filter(Boolean);
          process.stdout.write(commits.join('\n'));
          NODE

          if [[ ! -s /tmp/push_commits.txt ]]; then
            echo "No commits found in push payload; linting last commit only."
            npx commitlint --last --verbose
            exit 0
          fi

          status=0
          while IFS= read -r sha; do
            echo "::group::commitlint $sha"
            git show -s --format=%B "$sha" | npx commitlint --verbose || status=1
            echo "::endgroup::"
          done < /tmp/push_commits.txt
          exit "$status"

      - name: Validate PR commits
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
